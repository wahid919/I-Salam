<?php

/* @var $this yii\web\View */
/* @var $searchModel common\models\AbsensiSearch */
/* @var $dataProvider yii\data\ActiveDataProvider */

use app\models\KelompokRekening;
use app\models\TransaksiUang;
use yii\helpers\Html;

$this->title = 'Neraca';
$this->params['breadcrumbs'][] = $this->title;
$month = date('m');
$mm = date('F');
// var_dump($mm);
// die;
$year = date('Y');
$datenow = date('Y-m-d');
$f = date('F');
$sum_debit = TransaksiUang::find()
    ->where(['and', ['>=', 'tanggal', "$year-$month-01"], ['<=', 'tanggal', "$datenow"]])
    ->sum('debit');
$sum_kredit = TransaksiUang::find()
    ->where(['and', ['>=', 'tanggal', "$year-$month-01"], ['<=', 'tanggal', "$datenow"]])
    ->sum('kredit');
// $saldo_last = TransaksiUang::find()
// ->where(['and', ['>=', 'tanggal', "$year-$month-01"], ['<=', 'tanggal', "$datenow"]])
// ->select(['saldo_akhir'])
// ->limit(1)
// ->orderBy(['id' => SORT_DESC])
// ->findAll();
$saldo_last = (new \yii\db\Query())
    ->select('saldo_akhir')
    ->from('transaksi_uang')
    ->where(['and', ['>=', 'tanggal', "$year-$month-01"], ['<=', 'tanggal', "$datenow"]])
    ->limit(1)
    ->orderBy(['id' => SORT_DESC])
    ->all();
// $saldo_last = $query->all();
// echo $saldo_last->createCommand()->sql;
$kelompokbos = KelompokRekening::find()
    ->where(['kelompok' => 'debit'])
    ->select('id')->all();
$transaksi_uang = TransaksiUang::find()->where(['id_kelompok_rekening' => $kelompokbos])->groupBy('id_kelompok_rekening');
$kas_kecil = TransaksiUang::find()->where(['id_kelompok_rekening' => '1102'])
    ->select(['sum(debit) as debit'])->all();
$kas = TransaksiUang::find()->where(['id_kelompok_rekening' => '1101'])
    ->select(['sum(debit) as debit'])->all();
$hutang = (new \yii\db\Query())
    ->select(['b.nama', 'sum(a.kredit) as kredit'])
    ->from('transaksi_uang a')
    ->leftJoin('kelompok_rekening b', 'a.id_kelompok_rekening=b.id')
    ->Where(['between', 'b.id', "2101", "2103"])
    ->groupBy('b.nama')->all();
// $hutang=KelompokRekening::find()->where(['between', 'id', "2101", "2103" ])->all();
// $aktivitas=KelompokRekening::find()->where(['between', 'id', "1101", "1112" ])->all();
// $aktivas=TransaksiUang::find()->select(['kelompok_rekening.nama','sum(debit) as debit'])
// ->where(['kelompok_rekening.kelompok'=>"debit"])
// ->groupBY('kelompok_rekening.nama')
// ->joinWith(['kelompokRekening']);
$hutanguang = TransaksiUang::find()->select(['kelompok_rekening.nama', 'sum(kredit) as kredit'])
    ->where(['between', 'kelompok_rekening.id', "2101", "2103"])
    ->joinWith(['kelompokRekening']);
// $aktivas=TransaksiUang::find()->select(['kelompok_rekening.nama','sum(transaksi_uang.debit) as debit'])
// ->leftJoin('kelompok_rekening', 'transaksi_uang.id_kelompok_rekening=kelompok_rekening.id')
// ->where(['between', 'kelompok_rekening.id', "1101", "1112" ])
// ->groupBy('kelompok_rekening.nama');

$aktivas = (new \yii\db\Query())
    ->select(['b.nama', 'sum(a.debit) as debit'])
    ->from('transaksi_uang a')
    ->leftJoin('kelompok_rekening b', 'a.id_kelompok_rekening=b.id')
    ->Where(['between', 'b.id', "1101", "1112"])
    ->groupBy('b.nama')->all();

// echo json_encode($aktivas);
// exit;
// var_dump($hut->createCommand()->getRawSql());
// exit;

$listaktivas = TransaksiUang::find()->where(['between', 'id_kelompok_rekening', "1102", "1112"])->all();
?>
<div class="row" style="padding: 0px 20px 0px 20px">
   <div class="col-md-12">
      <table class="table table table-striped table-bordered" id="export">
         <thead>
            <tr>
               <th width="15%">AKTIVA</th>
               <th width="15%"><?=$f?></th>
               <th>Periode Lalu</th>
               <th width="15%">PASIVA</th>
               <th width="15%"><?=$f?></th>
               <th>Periode Lalu</th>
            </tr>
         </thead>
         <tbody>
            <th width="10%">AKTIVA LANCAR(1)</th>
            <th width="15%"></th>
            <th></th>
            <th width="5%">HUTANG</th>
            <th width="15%"></th>
            <th></th>
            <?php 
            foreach ($aktivas as $aktiva) {?>
            <tr>
               <td><?=$aktiva['nama']?></td>
               <td><?=$aktiva['debit']?></td>
               <td></td>
            </tr>
            <?php }?>
            <?php foreach ($hutang as $hut) {?>
            <tr>
               <td><?=$hut['nama']?></td>
               <td><?=$hut['kredit']?></td>
               <td></td>
            </tr>
            <?php }?>
         </tbody>
      </table>
   </div>
</div>